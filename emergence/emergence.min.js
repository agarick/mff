let UTIL={TAU:Math.PI*2,is_empty:function(o)
{return Object.keys(o).length===0&&o.constructor===Object},clone:function(o)
{return JSON.parse(JSON.stringify(o))},mod:function(n,b)
{n%=b;if(n<0)
{n+=b}
return n},rad:function(n)
{return n/360*UTIL.TAU},deg:function(n)
{return n*360/UTIL.TAU},uniform:function(n)
{return Math.random()*n},gaussian:function(n)
{let a=0;let b=0;while(a===0)a=Math.random();while(b===0)b=Math.random();let x=Math.sqrt(-2*Math.log(a))*Math.cos(UTIL.TAU*b);x=(x/10)+0.5;if(x>1||x<0)return UTIL.normal(n);return x*n},middle:function(n)
{let factor=4;return(Math.random()*n/factor)+(n/2)-(n/2/factor)},prep:function(state)
{let u=UTIL;let o=u.clone(state);if(o.a)o.a=u.rad(o.a);if(o.b)o.b=u.rad(o.b);return o},auto_radius:function(world,state)
{return Math.round(Math.sqrt(world.w*world.h*state.den/state.num/Math.PI))},for_abbrev:function(params,f)
{for(let key in params)
{if(params.hasOwnProperty(key))
{f(key)}}},debug_params:function(world,state)
{let o=state.distr;console.log("EMERGENCE\n---------"+"\nwidth  = "+world.w+"\nheight = "+world.h+"\nstop   = "+state.stop+"\ndistr   = "+(o===0?"uniform":o===1?"gaussian":o===2?"middle":"ERROR")+"\nfps    = "+state.fps+"\nnum    = "+state.num+"\npt-sz  = "+state.psz+"\nrad    = "+state.rad+"\ndens   = "+state.den+"\nalpha  = "+state.a+"\nbeta   = "+state.b+"\ngamma  = "+state.g+"\nspeed  = "+world.speed+"\n---------")},};function headless()
{return!(typeof window!="undefined"&&window.document)}
if(headless())
{module.exports={is_empty:UTIL.is_empty,clone:UTIL.clone,mod:UTIL.mod,rad:UTIL.rad,deg:UTIL.deg,uniform:UTIL.uniform,gaussian:UTIL.gaussian,middle:UTIL.middle,prep:UTIL.prep,auto_radius:UTIL.auto_radius,for_abbrev:UTIL.for_abbrev,debug_params:UTIL.debug_params,}}
let VIEW={init:function()
{document.addEventListener("keyup",VIEW.handle_key);if(window.File&&window.FileReader&&window.FileList&&window.Blob)
{document.getElementById("button-modal-open-real").addEventListener("change",VIEW.handle_file);document.getElementById("button-modal-open").classList.add("button-show")}
document.getElementById("slider").oninput=VIEW.slider_load},erase:function(c,w,h)
{c.clearRect(0,0,w,h)},paint:function(c,pts,n,w,h,rad,hue,avg,theme)
{let p;VIEW.erase(c,w,h);for(let i=0;i<n;i++)
{p=pts[i];c.fillStyle="hsl("+hue(p.n,avg,theme)+",100%,50%)";c.fillRect(p.x,p.y,rad,rad)}},toggle:function(paused,tick,fps)
{let button=document.getElementById("button-bar-toggle");if(paused)
{button.value="PAUSE";animate=setInterval(tick,(1000/fps));if(WORLD.tick<WORLD.hbsz)
{VIEW.slider_disable()}
if(DEBUG)console.log("(toggle) play")}
else{button.value="RESUME";window.clearTimeout(animate);if(DEBUG)console.log("(toggle) pause")}},get_canvas:function()
{let c=document.querySelector("canvas");return{canvas:c,context:c.getContext("2d"),}},get_dimensions:function(gap)
{return{w:window.innerWidth,h:window.innerHeight-gap,}},handle_key:function(event)
{switch(event.key)
{case " ":BRDG.toggle();break;default:}},handle_file:function(event)
{let r=new FileReader();r.onload=function()
{let area=document.querySelector(".textarea.load");area.value=r.result;area.focus();event.target.value=null};r.readAsText(event.target.files[0])},button_bar_help:function()
{document.querySelector(".modal.help").classList.toggle("modal-show");BRDG.pause()},button_bar_load:function()
{let msg=VIEW.message_clear("load");let area=document.querySelector(".textarea.load");area.value="";VIEW.modal_reset("load",function()
{area.focus()});BRDG.pause()},button_bar_save:function()
{let msg=VIEW.message_clear("save");let area=document.querySelector(".textarea.save");area.value=CORE.encode(CORE.get_snapshot());VIEW.modal_reset("save",function()
{area.focus();area.select();area.scrollTop=0});BRDG.pause()},button_bar_restart:function()
{let s=BRDG.get_state();let p=VIEW.get_params();BRDG.load(p);BRDG.toggle();BRDG.set_tick(0);VIEW.put_stop_calm();VIEW.put_params(p);CORE.init();BRDG.resume();if(DEBUG)UTIL.debug_params(BRDG.get_world(),s)},button_bar_apply:function()
{let s=BRDG.get_state();let p=VIEW.get_params();BRDG.load(p);BRDG.toggle();VIEW.put_params(p);CORE.init(!0,!0);BRDG.resume();if(DEBUG)UTIL.debug_params(BRDG.get_world(),s)},button_modal_apply:function()
{let msg=VIEW.message_clear("load");let text=document.querySelector(".textarea.load").value;let s=BRDG.get_state();let parsed;try
{parsed=CODE.decode(text);if(UTIL.is_empty(parsed))
{throw "empty state"}
VIEW.load(parsed,!0)}
catch(err)
{msg.classList.add("bad");msg.textContent='Unparsable (see "HELP" on state)';if(DEBUG)console.log(err);if(DEBUG)console.log("(button_modal_apply) parse & load failed");return}
VIEW.button_bar_load();CORE.init(!0,!0);if(parsed.p)
{BRDG.set_tick(0)}
BRDG.resume();if(DEBUG)console.log("(button_modal_apply) applied");if(DEBUG)UTIL.debug_params(BRDG.get_world(),s)},button_modal_save:function()
{let msg=VIEW.message_clear("save");let text=document.querySelector(".textarea.save").value;if(!text)
{msg.classList.add("bad");msg.textContent="Nothing to save";if(DEBUG)console.log("(button_modal_save) empty")}
else{let ref="data:text/plain;charset=utf-8,"+text;let date=new Date();let d=date.getFullYear().toString()+("0"+(date.getMonth()+1)).slice(-2)+("0"+date.getDate()).slice(-2)+date.getHours().toString()+date.getMinutes().toString()+date.getSeconds().toString();let a=document.createElement("a");a.href=ref;a.download="emergence_save_"+d+".txt";document.body.appendChild(a);a.click();document.body.removeChild(a);msg.classList.add("good");msg.textContent="Saved: "+a.download;if(DEBUG)console.log("(button_modal_save) saved")}},button_modal_copy:function()
{let area=document.querySelector(".textarea.save");area.focus();area.select();let msg=VIEW.message_clear("save");let copied=document.execCommand("copy");if(!area.value)
{msg.classList.add("bad");msg.textContent="Nothing to copy";if(DEBUG)console.log("(button_modal_copy) empty")}
else if(copied)
{msg.classList.add("good");msg.textContent="Copied to clipboard";if(DEBUG)console.log("(button_modal_copy) copied")}
else{msg.classList.add("bad");msg.textContent="Copy failed";if(DEBUG)console.log("(button_modal_copy) copy failed")}},message_clear:function(which)
{let msg=document.querySelector(".message."+which);msg.classList.remove("good","bad");msg.textContent="";return msg},modal_reset:function(which,action)
{let modal=document.querySelector(".modal."+which);if(modal.classList.contains("modal-show"))
{document.addEventListener("keyup",VIEW.handle_key)}
else{document.removeEventListener("keyup",VIEW.handle_key);setTimeout(action,0)}
modal.classList.toggle("modal-show")},select_config:function()
{if(DEBUG)console.log("(select_config)");let config=BRDG.get_config(parseInt(document.getElementById("param_c").value));document.getElementById("param_a").value=config.a;document.getElementById("param_b").value=config.b;BRDG.load(config)},select_theme:function()
{if(DEBUG)console.log("(select_theme)");let theme=BRDG.set_theme(parseInt(document.getElementById("param_t").value));BRDG.clear_theme_cache();document.getElementById("bar").style.backgroundColor=theme[0];document.querySelector("canvas").style.backgroundColor=theme[1];let spans=document.querySelectorAll("span.param");for(let i=0;i<spans.length;i++)
{spans[i].style.color=theme[2]}},select_distr:function()
{if(DEBUG)console.log("(select_distr)");let w=BRDG.get_world();VIEW.erase(w.c,w.w,w.h);BRDG.pause();BRDG.set_distr(parseInt(document.getElementById("param_o").value));BRDG.set_tick(0);VIEW.slider_set(0);VIEW.put_stop_calm();VIEW.put_params(CORE.get_params());VIEW.put_start();CORE.init()},slider_load:function()
{BRDG.pause();BRDG.load(BRDG.get_history().snaps[this.value-1]);BRDG.set_tick(this.value);CORE.init(!0,!0);BRDG.paint()},slider_disable:function()
{if(DEBUG)console.log("(slider_disable)");document.getElementById("slider").disabled=!0},slider_enable:function()
{if(DEBUG)console.log("(slider_enable)");document.getElementById("slider").disabled=!1},slider_set:function(tick)
{document.getElementById("slider").value=tick},put_start:function()
{document.getElementById("button-bar-toggle").value="START"},put_stop_alert:function()
{document.getElementById("stop").classList.add("alert")},put_stop_calm:function()
{document.getElementById("stop").classList.remove("alert")},put_params:function(o)
{UTIL.for_abbrev(BRDG.get_abbrev(),function(key){if(o[key]!=="")
{document.getElementById("param_"+key).value=o[key].toString()}})},get_params:function()
{let o={};let f;UTIL.for_abbrev(BRDG.get_abbrev(),function(key){if(["s","o","f","n","z"].includes(key))
{f=parseInt}
else if(["r","d","a","b","g"].includes(key))
{f=parseFloat}
o[key]=f(document.getElementById("param_"+key).value)})
VIEW.fallback(o);return o},load:function(o,keep)
{let has=!1;UTIL.for_abbrev(BRDG.get_abbrev(),function(key)
{if(o[key])
{has=!0}})
if(!has)throw "unmembered state";VIEW.fallback(o,keep);VIEW.put_params(o);BRDG.load(o)},fallback:function(o,keep)
{if(!keep)
{let a=BRDG.get_abbrev()
let w=BRDG.get_world();let s=BRDG.get_state();let ds=BRDG.get_state_default();UTIL.for_abbrev(a,function(key)
{if(isNaN(o[key]))
{if(key==="r")
{o[key]=UTIL.auto_radius(w,s)}
else{o[key]=ds[a[key]]}}})}},};let BRDG={init:function()
{let c=VIEW.get_canvas();WORLD.canvas=c.canvas;WORLD.c=c.context;BRDG.measure();CORE.init();VIEW.init();VIEW.put_params(CORE.get_params());BRDG.resume();if(DEBUG)UTIL.debug_params(WORLD,STATE)},measure:function()
{let dim=VIEW.get_dimensions(WORLD.gap);WORLD.canvas.width=dim.w;WORLD.canvas.height=dim.h;WORLD.w=dim.w;WORLD.h=dim.h;WORLD.whalf=WORLD.w/2;WORLD.hhalf=WORLD.h/2},resize:function()
{BRDG.pause();BRDG.measure();BRDG.set_tick(0);VIEW.slider_set(0);VIEW.put_params(CORE.get_params());VIEW.put_start();CORE.init()},toggle:function()
{VIEW.toggle(WORLD.paused,CORE.tick,STATE.fps);if(WORLD.paused)
{WORLD.paused=!1}
else{WORLD.paused=!0}},resume:function()
{if(WORLD.paused)
{if(WORLD.tick<WORLD.hbsz)
{VIEW.slider_disable()}
BRDG.toggle()}},pause:function()
{if(!WORLD.paused)
{BRDG.toggle()}},tally:function()
{let w=WORLD;let s=CORE.get_snapshot();let h=HIST;let k=w.tick;let z=w.hbsz;let tick=k%z;if(tick===0)
{if(k===z)
{VIEW.slider_set(100);VIEW.slider_enable()}
else{for(let i=0;i<z/2;i++)
{h.snaps[i]=h.snaps[i*2]}
for(let i=0;i<z/2;i++)
{h.snaps[i+z/2]=h.buf[i*2]}}
h.snaps[z-1]=s}
else{if(k<z)
{VIEW.slider_set(k);h.snaps[k-1]=s}
else{h.buf[tick-1]=s}}},paint:function()
{let w=WORLD;let s=STATE;VIEW.paint(w.c,PTS,s.num,w.w,w.h,s.psz,BRDG.hue,w.crowd,w.theme)},hue:function(n,avg,theme)
{let h=WORLD.hues;if(h[n]===undefined)
{let c;if(n<=avg)
{c=theme[3]}
else if(n<=2*avg)
{c=theme[4]}
else if(n<=4*avg)
{c=theme[5]}
else{c=theme[6]}
h[n]=c}
return h[n]},get_world:function()
{return WORLD},get_state:function()
{return STATE},get_state_default:function()
{return STATED},get_history:function()
{return HIST},get_pts:function()
{return PTS},get_abbrev:function()
{return ABBREV},get_config:function(c)
{return CONFIGS[c]},set_theme:function(theme)
{WORLD.theme=COLORS[theme];return WORLD.theme},set_distr:function(distr)
{STATE.distr=distr;return distr},set_tick:function(tick)
{WORLD.tick=tick},put_stop_alert:function()
{VIEW.put_stop_alert()},clear_theme_cache:function()
{WORLD.hues=[]},load:function(o)
{let a=ABBREV;let s=STATE;UTIL.for_abbrev(a,function(key)
{if(o[key])
{s[a[key]]=o[key]}})
if(o.r)
{WORLD.radsq=o.r*o.r}
let np=new Array(s.num);let nl;if(o.p)
{let p;for(let i=0;i<(o.p.length>s.num?s.num:o.p.length);i++)
{p=o.p[i];np[i]=new CORE.Pt(p.x,p.y,p.phi);np[i].n=0;np[i].l=0;np[i].r=0;np[i].s=Math.sin(p.phi);np[i].c=Math.cos(p.phi)}
nl=o.p.length}
else{for(let i=0;i<s.num;i++)
{np[i]=PTS[i]}
nl=PTS.length}
for(let i=nl;i<s.num;i++)
{np[i]=new CORE.Pt()}
PTS=np},};function headless()
{return!(typeof window!="undefined"&&window.document)}
let U;if(headless())U=require("./util");else U=UTIL;let DEBUG=!0;const TAU=Math.PI*2;const COLORS=[["#76c4ae","#bee9e4","#000000",240,290,0,40],["#363631","#16161d","#ffffff",140,320,240,40],["#ebebeb","#ffffff","#000000",200,320,240,40],["#fed6f1","#fff2e9","#000000",290,240,20,0],["#cae6fc","#daedfd","#000000",200,240,0,40],];const CONFIGS=[{a:180,b:17},{a:180,b:-7},{a:180,b:-15},{a:90,b:-21},{a:0,b:-10},{a:0,b:-41},{a:0,b:-25},{a:-180,b:-48},{a:-180,b:5},{a:-159,b:15},{a:0,b:1},{a:-180,b:58},{a:0,b:40},{a:0,b:8},{a:0,b:0},{a:45,b:4},];const ABBREV={s:"stop",o:"distr",f:"fps",n:"num",z:"psz",r:"rad",d:"den",a:"a",b:"b",g:"g",};let WORLD={canvas:null,c:null,w:null,h:null,whalf:null,hhalf:null,gap:61,hues:[],theme:COLORS[0],paused:!0,tick:0,hbsz:100,radsq:null,speed:null,crowd:null,};const STATED={stop:0,distr:0,fps:30,num:4000,psz:3,rad:null,den:8.0,a:180,b:17,g:0.134,};let STATE=U.clone(STATED);let PTS;let HIST={snaps:new Array(WORLD.hbsz),buf:new Array(WORLD.hbsz),};let CORE={Pt:function(x,y,phi)
{let u=U;let w=WORLD;let s=STATE;if(x)
{this.x=x}
else{let f;if(s.distr===0)f=u.uniform;else if(s.distr===1)f=u.gaussian;else if(s.distr===2)f=u.middle;this.x=f(w.w)}
if(y)
{this.y=y}
else{let f;if(s.distr===0)f=u.uniform;else if(s.distr===1)f=u.gaussian;else if(s.distr===2)f=u.middle;this.y=f(w.h)}
this.phi=phi?phi:Math.random()*TAU;this.n=0;this.l=0;this.r=0;this.sin=Math.sin(this.phi);this.cos=Math.cos(this.phi)},init:function(keep_pts,keep_rad)
{let w=WORLD;let s=STATE;if(!keep_pts)
{PTS=new Array(s.num);for(let i=0;i<s.num;i++)
{PTS[i]=new CORE.Pt()}}
if(!keep_rad)
{s.rad=U.auto_radius(w,s)}
w.radsq=s.rad*s.rad;w.speed=s.g*s.rad},tick:function()
{let c=CORE;let b=BRDG;let w=WORLD;let s=STATE;if(!s.stop||w.tick<s.stop)
{w.tick++;b.tally();b.paint();c.next(c,w)}
else{b.pause();b.put_stop_alert()}},next:function(core,world)
{let u=U;let s=STATE;let p=PTS;let tau=TAU;let sin=Math.sin;let cos=Math.cos;let floor=Math.floor;let sgn=Math.sign;let mod=u.mod;core.reset(s,p,sin,cos);core.near(world,s,p,floor,mod);core.crowd(world,s,p,floor);core.move(world,u.prep(s),p,tau,sin,cos,sgn,mod)},reset:function(state,pts,sin,cos)
{let p;for(let i=0;i<state.num;i++)
{p=pts[i];p.n=0;p.l=0;p.r=0;p.sin=sin(p.phi);p.cos=cos(p.phi)}},near:function(world,state,pts,floor,mod)
{CORE.from(world,pts,CORE.grid_init(world.w,world.h,state.rad,pts,floor),mod)},crowd:function(world,state,pts,floor)
{let sum=0;for(let i=0;i<state.num;i++)
{sum+=pts[i].n}
world.crowd=floor(sum/state.num)},move:function(world,state,pts,tau,sin,cos,sgn,mod)
{let p;for(let i=0;i<state.num;i++)
{p=pts[i];let delta=state.a+(state.b*p.n*sgn(p.r-p.l));p.phi=mod(p.phi+delta,tau);p.sin=sin(p.phi);p.cos=cos(p.phi);p.x=mod(p.x+world.speed*p.cos,world.w);p.y=mod(p.y+world.speed*p.sin,world.h)}},grid_init:function(w,h,rad,pts,floor)
{let cols=rad>w?1:floor(w/rad);let rows=rad>h?1:floor(h/rad);let xs=w/cols;let ys=h/rows;let units=new Array(cols);for(let i=0;i<cols;i++)
{units[i]=new Array(rows);for(j=0;j<rows;j++)
{units[i][j]=[]}}
for(let i=0;i<pts.length;i++)
{units[floor(pts[i].x/xs)][floor(pts[i].y/ys)].push(i)}
return([units,cols,rows])},from:function(world,pts,grid,mod)
{let units=grid[0];let cols=grid[1];let rows=grid[2];for(let col=0;col<cols;col++)
{for(let row=0;row<rows;row++)
{for(let n=0;n<units[col][row].length;n++)
{CORE.to(world,pts,units,cols,rows,col,row,units[col][row][n],mod)}}}},to:function(world,pts,units,cols,rows,col,row,a,mod)
{let i;let j;for(let c=col-1;c<=col+1;c++)
{for(let r=row-1;r<=row+1;r++)
{i=mod(c,cols);j=mod(r,rows);for(let n=0;n<units[i][j].length;n++)
{CORE.calculate(world,pts,a,units[i][j][n],mod)}}}},calculate:function(world,pts,ai,bi,mod)
{if(bi>=ai)
{return}
let w2=world.whalf;let h2=world.hhalf;let a=pts[ai];let b=pts[bi];let dx=mod(b.x-a.x+w2,world.w)-w2;let dy=mod(b.y-a.y+h2,world.h)-h2;if(world.radsq>=dx*dx+dy*dy)
{a.n++;b.n++;if(0>dx*a.sin-dy*a.cos)
{a.r++}
else{a.l++}
if(0<dx*b.sin-dy*b.cos)
{b.r++}
else{b.l++}}},get_params:function()
{let a=ABBREV;let s=STATE;let o={};U.for_abbrev(a,function(key)
{o[key]=s[a[key]]});return o},get_snapshot:function()
{let params=CORE.get_params();params.p=[];let p;for(let i=0;i<params.n;i++)
{p=PTS[i];params.p[i]={x:p.x,y:p.y,phi:p.phi,}}
return params},decode:function(s)
{let tmp=[];let lines=s.replace(/\n+/g,"\n").split("\n");for(let i=0;i<lines.length;i++)
{tmp[i]=lines[i].replace(/\s+/g," ").split(" ")}
let o={s:parseInt(tmp[0][0]),o:parseInt(tmp[0][1]),f:parseInt(tmp[0][2]),n:parseInt(tmp[0][3]),z:parseInt(tmp[0][4]),r:parseFloat(tmp[0][5]),d:parseFloat(tmp[0][6]),a:parseFloat(tmp[0][7]),b:parseFloat(tmp[0][8]),g:parseFloat(tmp[0][9]),p:[],};for(let i=1;i<lines.length;i++)
{o.p[i-1]={x:parseFloat(tmp[i][0]),y:parseFloat(tmp[i][1]),z:parseFloat(tmp[i][2]),}}
return o},encode:function(o)
{let s=(o.s).toString()+" "+(o.o).toString()+" "+(o.f).toString()+" "+(o.n).toString()+" "+(o.z).toString()+" "+(o.r).toString()+" "+(o.d).toString()+" "+(o.a).toString()+" "+(o.b).toString()+" "+(o.g).toString();for(let i=0;i<o.p.length;i++)
{s+="\n"+(o.p[i].x).toString()+" "+(o.p[i].y).toString()+" "+(o.p[i].phi).toString()}
return s},};if(headless())
{const args=process.argv.splice(2);let c=CORE;let w=WORLD;w.w=500;w.h=500;w.whalf=w.w/2;w.hhalf=w.h/2;c.init();STATE.stop=100;while(w.tick<STATE.stop)
{w.tick++;c.next(c,w)}
console.log(c.encode(c.get_snapshot()))}